<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Êñá‰ª∂ÊµèËßàÂô®</title>
    <style>
        body { font-family: sans-serif; margin: 0; }
        nav { background-color: #333; padding: 10px; }
        nav a { color: white; text-decoration: none; padding: 10px; }
        nav a:hover { background-color: #555; }
        #container { display: flex; height: calc(100vh - 40px); }
        #dir-tree { width: 30%; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; }
        #content { width: 70%; padding: 10px; display: flex; flex-direction: column; }
        #breadcrumb { font-size: 14px; color: #555; margin-bottom: 8px; }
        #file-list { border: 1px solid #ccc; flex: 1; overflow-y: auto; }
        #open-files { margin-top: 10px; border: 1px solid #ccc; padding: 8px; min-height: 200px; max-height: 40vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.open-file { border: 1px solid #ddd; border-radius: 6px; }
.open-file-header { background: #f5f5f5; padding: 6px 8px; display:flex; justify-content: space-between; align-items:center; }
.open-file-body { padding: 8px; white-space: pre-wrap; }
.open-file audio { width: 100%; }
.open-file .close { cursor: pointer; border: none; background: transparent; font-size: 16px; }
        .dir-item, .file-item { cursor: pointer; padding: 2px 4px; }
        .dir-item:hover, .file-item:hover { background-color: #eee; }
        .indent { display: inline-block; width: 16px; }
        .toggle { display: inline-block; width: 16px; text-align: center; color: #888; }
        .name { margin-left: 4px; }
        .empty { color: #888; padding: 8px; }
        #file-list .grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 8px; padding: 8px; }
        .tile-item { border: 1px solid #ddd; border-radius: 6px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 110px; cursor: pointer; }
        .tile-item:hover { background-color: #f7f7f7; }
        .tile-icon { font-size: 28px; }
        .tile-name { margin-top: 6px; font-size: 13px; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
    </style>
</head>
<body>
    {% include 'nav.html' %}
    <div id="container">
        <div id="dir-tree">
            <h2>ÁõÆÂΩï</h2>
            <div id="tree-root"></div>
        </div>
        <div id="content">
            <h2>Êñá‰ª∂</h2>
            <h3 style="margin:6px 0;">‰ΩçÁΩÆ</h3>
            <div id="breadcrumb"></div>
            <div id="file-list"></div>
            <h3 style="margin:10px 0 6px;">ÊâìÂºÄÁöÑÊñá‰ª∂</h3>
            <div id="open-files"></div>
        </div>
    </div>

    <script>
        const treeRootEl = document.getElementById('tree-root');
        const fileListEl = document.getElementById('file-list');
        const breadcrumbEl = document.getElementById('breadcrumb');
        const openFilesEl = document.getElementById('open-files');

        let opened = {};
        async function openFile(path) {
            const p = norm(path);
            if (opened[p]) { opened[p].scrollIntoView({behavior:'smooth', block:'center'}); return; }
            const item = document.createElement('div');
            item.className = 'open-file';
            item.dataset.path = p;
            const header = document.createElement('div'); header.className = 'open-file-header';
            const nameSpan = document.createElement('span'); nameSpan.textContent = p; // ÊòæÁ§∫ÂÆåÊï¥Ë∑ØÂæÑ
            const closeBtn = document.createElement('button'); closeBtn.className = 'close'; closeBtn.textContent = '√ó'; closeBtn.title = 'ÂÖ≥Èó≠';
            closeBtn.onclick = () => { delete opened[p]; item.remove(); };
            header.appendChild(nameSpan); header.appendChild(closeBtn);
            const body = document.createElement('div'); body.className = 'open-file-body';
            const lower = p.toLowerCase();
            if (lower.endsWith('.mp3')) {
                body.innerHTML = `<audio controls src="/api/files/raw/${encodeURIComponent(p)}"></audio>`;
            } else {
                const response = await fetch(`/api/files/${encodeURIComponent(p)}`);
                const data = await response.json();
                if (data && typeof data.content === 'string') { body.textContent = data.content; }
                else { body.textContent = 'Êó†Ê≥ïËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ'; }
            }
            item.appendChild(header); item.appendChild(body);
            openFilesEl.appendChild(item);
            opened[p] = item;
        }

        let allFiles = [];
        let nodes = {}; // path -> { path, name, children: Set<string>, files: Array, expanded: boolean }
        let currentDirPath = '';

function updateBreadcrumb(path, fileName) {
    const n = norm(path);
    const segs = n ? n.split('/') : [];
    let html = 'ÂΩìÂâç‰ΩçÁΩÆ: ';
    html += `<a href="#" onclick="selectDir(''); return false;">/</a>`;
    let cumulative = '';
    for (const s of segs) {
        cumulative = cumulative ? `${cumulative}/${s}` : s;
        html += ` / <a href="#" onclick="selectDir('${cumulative}'); return false;">${s}</a>`;
    }
    if (fileName) {
        html += ` ‚Äî ÂΩìÂâçÊñá‰ª∂: <strong class="filename">${fileName}</strong>`;
    }
    breadcrumbEl.innerHTML = html;
}

        function norm(p) {
            return String(p || '').replace(/\\/g, '/').replace(/^\/+/, '');
        }
        function dirname(p) {
            const n = norm(p);
            const i = n.lastIndexOf('/');
            return i === -1 ? '' : n.slice(0, i);
        }
        function basename(p) {
            const n = norm(p);
            if (!n) return '/';
            const parts = n.split('/');
            return parts[parts.length - 1];
        }
        function ensureNode(path) {
            const npath = norm(path);
            if (!nodes[npath]) {
                nodes[npath] = { path: npath, name: npath ? basename(npath) : '/', children: new Set(), files: [], expanded: npath === '' };
            }
            return nodes[npath];
        }
        function addDir(path) {
            const node = ensureNode(path);
            const parent = ensureNode(dirname(path));
            parent.children.add(node.path);
        }
        function addFile(file) {
            const p = norm(file.path || file.name);
            const parentPath = dirname(p);
            const parent = ensureNode(parentPath);
            parent.files.push({ name: basename(p), path: p, size: file.size || 0 });
        }
        function buildTree() {
            nodes = {};
            ensureNode(''); // root
            for (const f of allFiles) {
                const p = norm(f.path || f.name);
                if (f.isDirectory) addDir(p);
            }
            for (const f of allFiles) {
                if (!f.isDirectory) addFile(f);
            }
        }
        function renderTree() {
            treeRootEl.innerHTML = '';
            function renderNode(path, depth) {
                const node = nodes[path];
                if (!node) return;
                const row = document.createElement('div');
                row.className = 'dir-item';
                row.dataset.path = path;
                // indent
                for (let i = 0; i < depth; i++) {
                    const ind = document.createElement('span');
                    ind.className = 'indent';
                    row.appendChild(ind);
                }
                // toggle
                const toggle = document.createElement('span');
                toggle.className = 'toggle';
                toggle.textContent = node.children.size > 0 ? (node.expanded ? '‚ñº' : '‚ñ∂') : '¬∑';
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    node.expanded = !node.expanded;
                    renderTree();
                };
                row.appendChild(toggle);
                // name
                const label = document.createElement('span');
                label.className = 'name';
                label.textContent = depth === 0 ? '/' : node.name;
                row.appendChild(label);
                // click to select dir
                row.onclick = () => {
                    selectDir(path);
                };
                treeRootEl.appendChild(row);
                // children
                if (node.expanded) {
                    const kids = Array.from(node.children).sort();
                    for (const k of kids) renderNode(k, depth + 1);
                }
            }
            renderNode('', 0);
        }
        function selectDir(path) {
            currentDirPath = path;
            updateBreadcrumb(path, null);
            if (!filePageByDir[path]) filePageByDir[path] = 1;
            renderFilesForDir(path);
        }
        const FILES_PER_PAGE = 15;
        let filePageByDir = {};
        function getPage(path) { return filePageByDir[path] || 1; }
        function setPage(path, p, totalPages) {
            const np = Math.min(Math.max(1, p), Math.max(1, totalPages));
            filePageByDir[path] = np;
            renderFilesForDir(path);
        }
        function extOf(name) {
            const i = (name || '').lastIndexOf('.');
            return i >= 0 ? name.slice(i + 1).toLowerCase() : '';
        }
        function getIcon(record) {
            if (record.kind === 'dir') return 'üìÅ'; // ÁõÆÂΩï‰∏ìÁî®Ôºå‰∏ç‰∏éÊñá‰ª∂Á±ªÂûãÈáçÂ§ç
            const ext = extOf(record.name);
            if (['mp3','wav','m4a','flac','ogg'].includes(ext)) return 'üéµ'; // Èü≥È¢ë
            if (['png','jpg','jpeg','gif','bmp','webp','svg'].includes(ext)) return 'üñºÔ∏è'; // ÂõæÁâá
            if (['pdf'].includes(ext)) return 'üìï'; // PDF
            if (['txt','log','ini','cfg','conf'].includes(ext)) return 'üìù'; // ÊñáÊú¨
            if (['md','markdown'].includes(ext)) return 'üìí'; // Markdown
            if (['csv'].includes(ext)) return 'üìä'; // CSV
            if (['doc','docx'].includes(ext)) return 'üìò'; // Word
            if (['xls','xlsx'].includes(ext)) return 'üìà'; // Excel
            if (['zip','rar','7z','tar','gz','tgz'].includes(ext)) return 'üóúÔ∏è'; // ÂéãÁº©ÂåÖ
            if (['py'].includes(ext)) return 'üêç'; // Python
            if (['js','ts','jsx','tsx'].includes(ext)) return 'üß©'; // JS/TS
            if (['json','yaml','yml','xml'].includes(ext)) return 'üóÇÔ∏è'; // ÁªìÊûÑÂåñÊï∞ÊçÆ
            if (['exe','dll','bin','msi'].includes(ext)) return '‚öôÔ∏è'; // ‰∫åËøõÂà∂/ÂèØÊâßË°å
            return 'üìÉ'; // ÂÖ∂‰ªñÊñá‰ª∂Á±ªÂûã
        }
        function renderFilesForDir(path) {
            fileListEl.innerHTML = '';
            const node = nodes[path];
            if (!node) return;
            const children = Array.from(node.children).sort((a,b) => nodes[a].name.localeCompare(nodes[b].name));
            const files = node.files.slice().sort((a,b) => a.name.localeCompare(b.name));
            // combine directories and files into one record list (dirs first)
            const records = [
                ...children.map(p => ({ kind: 'dir', path: p, name: nodes[p].name })),
                ...files.map(f => ({ kind: 'file', path: f.path, name: f.name }))
            ];
            const totalRecords = records.length;
            const page = getPage(path);
            const totalPages = Math.max(1, Math.ceil(totalRecords / FILES_PER_PAGE));
            const start = (page - 1) * FILES_PER_PAGE;
            const end = Math.min(start + FILES_PER_PAGE, totalRecords);

            // toolbar with stats and pagination (for records: dirs + files)
            const toolbar = document.createElement('div');
            toolbar.style.display = 'flex';
            toolbar.style.justifyContent = 'space-between';
            toolbar.style.alignItems = 'center';
            toolbar.style.padding = '6px 8px';
            toolbar.style.borderBottom = '1px solid #eee';

            const stats = document.createElement('div');
            stats.textContent = `ËÆ∞ÂΩïÔºöÂÖ± ${totalRecords} ‰∏™ | È°µ ${page}/${totalPages} | ÊòæÁ§∫ ${totalRecords ? (start+1) : 0}-${totalRecords ? end : 0}`;
            toolbar.appendChild(stats);

            const pager = document.createElement('div');
            const prevBtn = document.createElement('button'); prevBtn.textContent = '‰∏ä‰∏ÄÈ°µ';
            prevBtn.disabled = page <= 1; prevBtn.onclick = () => setPage(path, page - 1, totalPages);
            const nextBtn = document.createElement('button'); nextBtn.textContent = '‰∏ã‰∏ÄÈ°µ';
            nextBtn.disabled = page >= totalPages; nextBtn.onclick = () => setPage(path, page + 1, totalPages);
            pager.appendChild(prevBtn); pager.appendChild(nextBtn);
            toolbar.appendChild(pager);

            fileListEl.appendChild(toolbar);

            if (totalRecords === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫';
                fileListEl.appendChild(empty);
                return;
            }
            // render records with pagination in a 5-column grid
            const grid = document.createElement('div');
            grid.className = 'grid';
            const pageRecords = records.slice(start, end);
            for (const r of pageRecords) {
                const item = document.createElement('div');
                item.className = 'tile-item';
                const iconEl = document.createElement('div'); iconEl.className = 'tile-icon'; iconEl.textContent = getIcon(r);
                const nameEl = document.createElement('div'); nameEl.className = 'tile-name'; nameEl.textContent = r.kind === 'dir' ? `${r.name}/` : r.name;
                item.appendChild(iconEl); item.appendChild(nameEl);
                item.onclick = r.kind === 'dir' ? (() => selectDir(r.path)) : (() => viewFile(r.path));
                grid.appendChild(item);
            }
            fileListEl.appendChild(grid);
        }
        async function viewFile(path) {
            await openFile(path);
        }
        async function fetchAll() {
            const response = await fetch(`/api/files`);
            const data = await response.json();
            allFiles = Array.isArray(data.files) ? data.files : [];
            buildTree();
            renderTree();
            selectDir('');
        }
        fetchAll();
    </script>
</body>
</html>